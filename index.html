// ---------- DÉBUT : charger routes OSM et projeter lat/lon ----------
function lonLatToXY(lon, lat, W, H, bbox){
  const [minLon, minLat, maxLon, maxLat] = bbox;
  const xn = (lon - minLon) / (maxLon - minLon);
  const yn = (maxLat - lat) / (maxLat - minLat);
  return { x: xn * W, y: yn * H };
}

async function loadOSMRoads(bboxStr){
  const q = `[out:json][timeout:25];
  (
    way["highway"](${bboxStr});
  );
  (._;>;);
  out body;`;
  const url = 'https://overpass-api.de/api/interpreter';
  const res = await fetch(url, { method:'POST', body: q });
  if(!res.ok) throw new Error('Overpass error: '+res.status);
  const data = await res.json();
  const nodes = new Map();
  for(const el of data.elements) if(el.type === 'node') nodes.set(el.id, el);
  const newRoads = [];
  for(const el of data.elements){
    if(el.type === 'way'){
      const pts = [];
      for(const nid of el.nodes){
        const n = nodes.get(nid);
        if(!n) continue;
        const p = lonLatToXY(n.lon, n.lat, W, H, currentBBoxNumeric);
        pts.push(p);
      }
      if(pts.length > 1) newRoads.push(pts);
    }
  }
  return newRoads;
}

// bbox example (change la ville plus bas) : format lat_min,lon_min,lat_max,lon_max (south,west,north,east)
const bboxStrExample = "48.80,2.25,48.90,2.40"; // <- PARIS (exemple)
const currentBBoxNumeric = [2.25,48.80,2.40,48.90];

(async function initFromOSM(){
  try{
    console.log('Chargement routes OSM...');
    const osmRoads = await loadOSMRoads(bboxStrExample);
    console.log('routes chargées', osmRoads.length);
    roads.length = 0;
    for(const r of osmRoads) roads.push(r);
    initAgents(parseInt(sliderN.value));
  }catch(err){
    console.error('OSM load failed', err);
    // Si échec : retombe sur réseau synthétique existant (si tu veux)
    // (tu peux laisser ici les makeRingRoad/makeGrid en secours)
  }
})();
